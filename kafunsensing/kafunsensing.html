<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Excelデータ抽出・表示システム</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 40px; color: #333; background-color: #fdfdfd; }
        .container { max-width: 1200px; margin: auto; }
        h1 { font-size: 1.5rem; border-left: 5px solid #2e7d32; padding-left: 15px; margin-bottom: 30px; }
        
        /* 検索・操作エリア */
        .search-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; }
        select { padding: 10px; width: 240px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; background-color: #fff; }
        
        /* 印刷ボタンのデザイン */
        .print-btn {
            background-color: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px;
            font-size: 1rem; cursor: pointer; font-weight: bold; transition: background 0.3s; height: 42px;
        }
        .print-btn:hover { background-color: #115293; }
        .print-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* テーブルスタイル */
        .table-wrapper { overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; min-width: 800px; }
        th { background-color: #2e7d32; color: white; font-weight: 600; padding: 12px 10px; text-align: left; font-size: 0.85rem; }
        td { border-bottom: 1px solid #eee; padding: 10px; font-size: 0.9rem; }
        tr:hover { background-color: #f1f8e9; }

        /* --------------------------------------------------
           印刷用設定 (@media print)
           印刷ボタンを押した時、不要な要素を消してテーブルだけにする
        -------------------------------------------------- */
        @media print {
            body { margin: 0; padding: 0; background-color: white; }
            .search-box, h1, .print-btn { display: none !important; } /* 検索欄やボタンを隠す */
            .container { max-width: 100%; width: 100%; margin: 0; }
            .table-wrapper { box-shadow: none; border: none; margin: 0; overflow: visible; }
            table { width: 100%; border: 1px solid #000; }
            th { background-color: #eee !important; color: #000 !important; border: 1px solid #000; }
            td { border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>学生データ詳細</h1>
    
    <div class="search-box">
        <div class="input-group">
            <label id="label1">school_id：</label>
            <select id="mainSelector">
                <option value="">-- ファイル読み込み中 --</option>
            </select>
        </div>

        <div class="input-group">
            <label id="label2">user_id：</label>
            <select id="subSelector" disabled>
                <option value="">-- 先に所属を選択 --</option>
            </select>
        </div>

        <button id="printBtn" class="print-btn" disabled>この内容を印刷する</button>
    </div>

    <div id="printArea" class="table-wrapper">
        <table id="resultTable">
            <thead id="tableHeader"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let jsonData = [];
    let groupKey = "";
    let userKey = "user_id";

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('data.xlsx');
            if (!response.ok) throw new Error("Excelが見つかりません。");
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });

            if (jsonData.length > 0) {
                const allKeys = Object.keys(jsonData[0]);
                groupKey = allKeys[0];
                const foundUserKey = allKeys.find(k => k.toLowerCase().includes("user_id"));
                if (foundUserKey) userKey = foundUserKey;

                document.getElementById('label1').textContent = groupKey + "：";
                document.getElementById('label2').textContent = userKey + "：";
                initMainSelector();
            }
        } catch (error) {
            console.error(error);
            document.getElementById('mainSelector').innerHTML = '<option>エラー</option>';
        }
    });

    function initMainSelector() {
        const mainSel = document.getElementById('mainSelector');
        mainSel.innerHTML = '<option value="">-- 選択してください --</option>';
        const uniqueGroups = [...new Set(jsonData.map(item => item[groupKey]))].sort();
        uniqueGroups.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            mainSel.appendChild(opt);
        });
    }

    document.getElementById('mainSelector').addEventListener('change', function() {
        const selectedGroup = this.value;
        const subSel = document.getElementById('subSelector');
        subSel.innerHTML = '<option value="">-- 選択してください --</option>';
        subSel.disabled = !selectedGroup;
        document.getElementById('printBtn').disabled = true;

        if (selectedGroup) {
            const filteredData = jsonData.filter(row => String(row[groupKey]) === selectedGroup);
            const uniqueUsers = [...new Set(filteredData.map(item => item[userKey]))].sort();
            uniqueUsers.forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                subSel.appendChild(opt);
            });
        }
        clearTable();
    });

    document.getElementById('subSelector').addEventListener('change', function() {
        const selectedGroup = document.getElementById('mainSelector').value;
        const selectedUser = this.value;
        const headerArea = document.getElementById('tableHeader');
        const bodyArea = document.getElementById('tableBody');
        const printBtn = document.getElementById('printBtn');

        clearTable();
        if (!selectedUser) {
            printBtn.disabled = true;
            return;
        }

        const filtered = jsonData.filter(row => 
            String(row[groupKey]) === selectedGroup && String(row[userKey]) === selectedUser
        );

        if (filtered.length > 0) {
            printBtn.disabled = false; // データがあればボタンを有効化
            const columns = Object.keys(filtered[0]);
            const trHead = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                trHead.appendChild(th);
            });
            headerArea.appendChild(trHead);

            filtered.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] ?? "";
                    tr.appendChild(td);
                });
                bodyArea.appendChild(tr);
            });
        }
    });

    // 印刷ボタンのクリックイベント
    document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
    });

    function clearTable() {
        document.getElementById('tableHeader').innerHTML = '';
        document.getElementById('tableBody').innerHTML = '';
    }
</script>

</body>
</html>